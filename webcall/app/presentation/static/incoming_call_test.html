<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCall - –¢–µ—Å—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; max-height: 400px; overflow-y: auto; font-size: 12px; line-height: 1.4; }
        .controls { margin: 20px 0; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû WebCall - –¢–µ—Å—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤</h1>
        
        <div id="status" class="status info">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...</div>
        
        <div class="controls">
            <button class="button" onclick="checkSystem()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
            <button class="button success" onclick="simulateIncomingCall()">üìû –ò–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</button>
            <button class="button danger" onclick="clearState()">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
        </div>
        
        <div class="grid">
            <div>
                <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∞</h3>
                <div class="input-group">
                    <label for="fromUserId">–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ID):</label>
                    <input type="text" id="fromUserId" value="test-caller-123" />
                </div>
                <div class="input-group">
                    <label for="fromUsername">–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–º—è):</label>
                    <input type="text" id="fromUsername" value="TestCaller" />
                </div>
                <div class="input-group">
                    <label for="roomId">ID –∫–æ–º–Ω–∞—Ç—ã:</label>
                    <input type="text" id="roomId" value="call-test-room" />
                </div>
            </div>
            <div>
                <h3>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤</h3>
                <div id="callState" class="log">–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
            </div>
        </div>
        
        <div>
            <h3>üìã –õ–æ–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h3>
            <div id="logs" class="log">–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...</div>
        </div>
        
        <div>
            <h3>üõ†Ô∏è –†—É—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã</h3>
            <div class="controls">
                <button class="button" onclick="runCommand('window.debugWebSocket()')">WebSocket Debug</button>
                <button class="button" onclick="runCommand('window.getCallState()')">Call State</button>
                <button class="button" onclick="runCommand('window.getCallDebug()')">Call Debug</button>
                <button class="button" onclick="runCommand('window.__CALL_DEBUG')">Call Log</button>
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ timestamp, message, type });
            
            const logsDiv = document.getElementById('logs');
            const color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : type === 'success' ? '#28a745' : '#333';
            logsDiv.innerHTML += `<div style="color: ${color}">${logEntry}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function checkSystem() {
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∑–≤–æ–Ω–∫–æ–≤...', 'info');
            
            const checks = [
                { name: 'window.appState', obj: window.appState },
                { name: 'window.appState.friendsWs', obj: window.appState?.friendsWs },
                { name: 'window.getCallState', obj: window.getCallState },
                { name: 'window.getCallDebug', obj: window.getCallDebug },
                { name: 'localStorage.wc_token', obj: localStorage.getItem('wc_token') }
            ];
            
            let allGood = true;
            
            checks.forEach(check => {
                if (check.obj) {
                    log(`‚úÖ ${check.name}: –¥–æ—Å—Ç—É–ø–µ–Ω`, 'success');
                } else {
                    log(`‚ùå ${check.name}: –ù–ï–î–û–°–¢–£–ü–ï–ù`, 'error');
                    allGood = false;
                }
            });
            
            if (allGood) {
                updateStatus('–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é', 'success');
                updateCallState();
            } else {
                updateStatus('–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–∏—Å—Ç–µ–º–æ–π –∑–≤–æ–Ω–∫–æ–≤', 'error');
            }
        }
        
        function updateCallState() {
            try {
                if (typeof window.getCallState === 'function') {
                    const state = window.getCallState();
                    document.getElementById('callState').innerHTML = `
<strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞:</strong><br>
‚Ä¢ –§–∞–∑–∞: ${state.phase}<br>
‚Ä¢ –ö–æ–º–Ω–∞—Ç–∞: ${state.roomId || '–ù–µ—Ç'}<br>
‚Ä¢ –î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${state.otherUserId || '–ù–µ—Ç'}<br>
‚Ä¢ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${state.otherUsername || '–ù–µ—Ç'}<br>
‚Ä¢ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: ${state.finalReason || '–ù–µ—Ç'}
                    `;
                    log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞: ${state.phase}`, 'info');
                } else {
                    document.getElementById('callState').innerHTML = '‚ùå API getCallState –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                }
            } catch (e) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è: ${e.message}`, 'error');
            }
        }
        
        function simulateIncomingCall() {
            log('üìû –ò–º–∏—Ç–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞...', 'info');
            
            const fromUserId = document.getElementById('fromUserId').value;
            const fromUsername = document.getElementById('fromUsername').value;
            const roomId = document.getElementById('roomId').value;
            
            if (!window.appState?.friendsWs) {
                log('‚ùå WebSocket –¥—Ä—É–∑–µ–π –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                updateStatus('WebSocket –Ω–µ –≥–æ—Ç–æ–≤', 'error');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const token = localStorage.getItem('wc_token');
            if (!token) {
                log('‚ùå –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                updateStatus('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
                return;
            }
            
            let toUserId;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                toUserId = payload.sub;
                log(`üìã –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${toUserId}`, 'info');
            } catch (e) {
                log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${e.message}`, 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            const callMessage = {
                type: 'call_invite',
                fromUserId: fromUserId,
                toUserId: toUserId,
                fromUsername: fromUsername,
                toUsername: 'You',
                roomId: roomId
            };
            
            log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${JSON.stringify(callMessage, null, 2)}`, 'info');
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
            try {
                const event = {
                    data: JSON.stringify(callMessage)
                };
                
                // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞–ø—Ä—è–º—É—é
                if (window.appState.friendsWs.onmessage) {
                    window.appState.friendsWs.onmessage(event);
                    log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —á–µ—Ä–µ–∑ onmessage', 'success');
                } else {
                    log('‚ùå onmessage –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    updateCallState();
                    const currentState = typeof window.getCallState === 'function' ? window.getCallState() : null;
                    if (currentState && currentState.phase === 'incoming_invite') {
                        updateStatus('–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                        log('üéâ –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω!', 'success');
                    } else {
                        updateStatus('–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª—Å—è', 'warning');
                        log(`‚ö†Ô∏è –û–∂–∏–¥–∞–ª–æ—Å—å incoming_invite, –ø–æ–ª—É—á–∏–ª–∏: ${currentState?.phase}`, 'warning');
                    }
                }, 1000);
                
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–º–∏—Ç–∞—Ü–∏–∏: ${e.message}`, 'error');
                updateStatus('–û—à–∏–±–∫–∞ –∏–º–∏—Ç–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞', 'error');
            }
        }
        
        function clearState() {
            log('üóëÔ∏è –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤...', 'info');
            
            try {
                if (typeof window.resetCallSystem === 'function') {
                    window.resetCallSystem();
                    log('‚úÖ resetCallSystem –≤—ã–∑–≤–∞–Ω', 'success');
                } else {
                    log('‚ö†Ô∏è resetCallSystem –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–±—Ä–æ—Å –≤—Ä—É—á–Ω—É—é', 'warning');
                }
                
                updateCallState();
                updateStatus('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ', 'success');
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞: ${e.message}`, 'error');
            }
        }
        
        function runCommand(command) {
            log(`üîß –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${command}`, 'info');
            try {
                const result = eval(command);
                log(`üìã –†–µ–∑—É–ª—å—Ç–∞—Ç: ${JSON.stringify(result, null, 2)}`, 'success');
                updateCallState();
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${e.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            
            setTimeout(() => {
                checkSystem();
            }, 2000);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (typeof window.getCallState === 'function') {
                updateCallState();
            }
        }, 5000);
    </script>
</body>
</html>