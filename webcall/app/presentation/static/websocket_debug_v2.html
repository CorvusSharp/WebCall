<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCall - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebSocket v2</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .button.danger { background: #dc3545; }
        .button.danger:hover { background: #c82333; }
        .button.success { background: #28a745; }
        .button.success:hover { background: #218838; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .controls { margin: 20px 0; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç WebCall - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebSocket v2</h1>
        
        <div id="status" class="status info">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        
        <div class="controls">
            <button class="button" onclick="runDiagnostic()">üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
            <button class="button" onclick="testWebSocket()">üîó –¢–µ—Å—Ç WebSocket</button>
            <button class="button success" onclick="forceReconnect()">üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å</button>
            <button class="button danger" onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
        
        <div class="grid">
            <div>
                <h3>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>
                <div id="systemInfo" class="log">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div>
                <h3>üìû –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤</h3>
                <div id="callInfo" class="log">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
        
        <h3>üìã –õ–æ–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h3>
        <div id="logs" class="log">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...</div>
        
        <div class="controls">
            <button class="button" onclick="simulateCall()">üìû –ò–º–∏—Ç–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞</button>
            <button class="button" onclick="exportLogs()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤</button>
        </div>
    </div>

    <script>
        let logs = [];
        let diagnosticInterval;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ timestamp, message, type });
            
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML += `<div style="color: ${getLogColor(type)}">${logEntry}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function getLogColor(type) {
            switch(type) {
                case 'error': return '#dc3545';
                case 'warning': return '#ffc107';
                case 'success': return '#28a745';
                default: return '#333';
            }
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            log(`–°—Ç–∞—Ç—É—Å: ${message}`, type);
        }
        
        function runDiagnostic() {
            log('üîç –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            if (typeof window.debugWebSocket === 'function') {
                try {
                    const wsInfo = window.debugWebSocket();
                    log(`WebSocket: ${wsInfo.wsState}, –¢–æ–∫–µ–Ω: ${wsInfo.hasToken ? '–µ—Å—Ç—å' : '–ù–ï–¢'}`, wsInfo.hasToken ? 'success' : 'error');
                    
                    document.getElementById('systemInfo').innerHTML = `
                        <strong>WebSocket:</strong> ${wsInfo.wsState}<br>
                        <strong>–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:</strong> ${wsInfo.connecting ? '–î–∞' : '–ù–µ—Ç'}<br>
                        <strong>–¢–æ–∫–µ–Ω:</strong> ${wsInfo.hasToken ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç'}<br>
                        <strong>–ü–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong> ${wsInfo.reconnectAttempts}<br>
                        <strong>–í–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</strong> ${wsInfo.visibilityState}<br>
                        <strong>URL:</strong> ${wsInfo.url}
                    `;
                } catch (e) {
                    log(`–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ WebSocket: ${e.message}`, 'error');
                }
            } else {
                log('‚ùå –§—É–Ω–∫—Ü–∏—è debugWebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'error');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤
            if (typeof window.debugCalls === 'function') {
                try {
                    window.debugCalls();
                    log('‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
                } catch (e) {
                    log(`–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–≤–æ–Ω–∫–æ–≤: ${e.message}`, 'error');
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤
            try {
                if (typeof window.getCallState === 'function') {
                    const callState = window.getCallState();
                    document.getElementById('callInfo').innerHTML = `
                        <strong>–§–∞–∑–∞:</strong> ${callState.phase}<br>
                        <strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> ${callState.roomId || '–ù–µ—Ç'}<br>
                        <strong>–î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${callState.otherUsername || '–ù–µ—Ç'}
                    `;
                    log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤: ${callState.phase}`, 'info');
                } else {
                    document.getElementById('callInfo').innerHTML = '‚ùå API –∑–≤–æ–Ω–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    log('‚ùå API getCallState –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'warning');
                }
            } catch (e) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤: ${e.message}`, 'error');
            }
            
            // –û–±—â–∞—è —Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            log(`–ë—Ä–∞—É–∑–µ—Ä: ${navigator.userAgent}`, 'info');
            log(`–û–Ω–ª–∞–π–Ω: ${navigator.onLine ? '–î–∞' : '–ù–µ—Ç'}`, navigator.onLine ? 'success' : 'error');
            log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${navigator?.connection?.effectiveType || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`, 'info');
            
            updateStatus('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        }
        
        function testWebSocket() {
            log('üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...', 'info');
            
            const token = localStorage.getItem('wc_token');
            if (!token) {
                log('‚ùå –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                updateStatus('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                return;
            }
            
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            const url = `${proto}://${location.host}/ws/friends?token=${token}`;
            
            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫: ${url}`, 'info');
            
            const ws = new WebSocket(url);
            let connected = false;
            
            const timeout = setTimeout(() => {
                if (!connected) {
                    ws.close();
                    log('‚ùå –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (10 —Å–µ–∫—É–Ω–¥)', 'error');
                    updateStatus('–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket', 'error');
                }
            }, 10000);
            
            ws.onopen = () => {
                connected = true;
                clearTimeout(timeout);
                log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                updateStatus('WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'success');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π ping
                ws.send(JSON.stringify({ type: 'ping' }));
                log('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω ping', 'info');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    ws.close();
                    log('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'success');
                }, 2000);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${data.type}`, 'success');
                } catch {
                    log(`üì• –ü–æ–ª—É—á–µ–Ω–æ: ${event.data}`, 'info');
                }
            };
            
            ws.onerror = (error) => {
                log(`‚ùå –û—à–∏–±–∫–∞ WebSocket: ${error}`, 'error');
                updateStatus('–û—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            };
            
            ws.onclose = (event) => {
                log(`üîå WebSocket –∑–∞–∫—Ä—ã—Ç: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason}`, 'info');
            };
        }
        
        function forceReconnect() {
            log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
            
            if (typeof window.forceReconnectWebSocket === 'function') {
                try {
                    window.forceReconnectWebSocket();
                    log('‚úÖ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                    updateStatus('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket...', 'info');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        if (typeof window.debugWebSocket === 'function') {
                            const wsInfo = window.debugWebSocket();
                            if (wsInfo.wsState === 'OPEN') {
                                updateStatus('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ', 'success');
                            } else {
                                updateStatus(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${wsInfo.wsState}`, 'warning');
                            }
                        }
                    }, 3000);
                } catch (e) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${e.message}`, 'error');
                }
            } else {
                log('‚ùå –§—É–Ω–∫—Ü–∏—è forceReconnectWebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
            }
        }
        
        function simulateCall() {
            log('üìû –ò–º–∏—Ç–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞...', 'info');
            
            if (typeof window.startOutgoingCall === 'function') {
                try {
                    // –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–≥–æ –¥—Ä—É–≥–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
                    const testFriend = {
                        id: 'test-friend-id',
                        username: 'TestFriend'
                    };
                    
                    const result = window.startOutgoingCall(testFriend);
                    if (result) {
                        log('‚úÖ –ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                    } else {
                        log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–æ–∫', 'error');
                    }
                } catch (e) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ: ${e.message}`, 'error');
                }
            } else {
                log('‚ùå API –∑–≤–æ–Ω–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'error');
            }
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').innerHTML = '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã...';
            log('üóëÔ∏è –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã', 'info');
        }
        
        function exportLogs() {
            const logText = logs.map(entry => 
                `[${entry.timestamp}] [${entry.type.toUpperCase()}] ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `webcall-debug-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
            log('üíæ –õ–æ–≥–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üöÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            updateStatus('–ì–æ—Ç–æ–≤ –∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ', 'info');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è
            setTimeout(() => {
                if (typeof window.debugWebSocket === 'function') {
                    runDiagnostic();
                } else {
                    log('‚ö†Ô∏è –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–≤–æ–Ω–∫–æ–≤ —Å–Ω–∞—á–∞–ª–∞.', 'warning');
                    updateStatus('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'warning');
                }
            }, 2000);
        });
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        diagnosticInterval = setInterval(() => {
            if (typeof window.debugWebSocket === 'function') {
                const wsInfo = window.debugWebSocket();
                log(`–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: WS=${wsInfo.wsState}, –ü–æ–ø—ã—Ç–æ–∫=${wsInfo.reconnectAttempts}`, 'info');
            }
        }, 30000);
    </script>
</body>
</html>