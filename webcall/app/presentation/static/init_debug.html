<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCall - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; max-height: 400px; overflow-y: auto; font-size: 12px; line-height: 1.4; }
        .controls { margin: 20px 0; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
        .code-block { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 5px 0; border-radius: 4px; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç WebCall - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</h1>
        
        <div id="status" class="status info">–ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ...</div>
        
        <div class="controls">
            <button class="button" onclick="checkInitialization()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</button>
            <button class="button" onclick="checkWebSocket()">üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WebSocket</button>
            <button class="button" onclick="manualInit()">üöÄ –†—É—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</button>
            <button class="button" onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        
        <div class="grid">
            <div>
                <h3>üìã –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
                <div id="logs" class="log">–û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏...</div>
            </div>
            <div>
                <h3>‚öôÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>
                <div id="state" class="log">–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
            </div>
        </div>
        
        <div>
            <h3>üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏</h3>
            <div class="code-block">
                1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)<br>
                2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É –º–æ–¥—É–ª–µ–π: –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞<br>
                3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã:<br>
                &nbsp;&nbsp;- <code>window.appState</code> - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç<br>
                &nbsp;&nbsp;- <code>window.debugWebSocket()</code> - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebSocket<br>
                &nbsp;&nbsp;- <code>window.startFriendsWs()</code> - —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ WebSocket<br>
                4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞: <code>localStorage.getItem('wc_token')</code>
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ timestamp, message, type });
            
            const logsDiv = document.getElementById('logs');
            const color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : type === 'success' ? '#28a745' : '#333';
            logsDiv.innerHTML += `<div style="color: ${color}">${logEntry}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            log(`–°—Ç–∞—Ç—É—Å: ${message}`, type);
        }
        
        function checkInitialization() {
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
            const checks = [
                { name: 'window.appState', obj: window.appState },
                { name: 'window.showToast', obj: window.showToast }, 
                { name: 'window.startFriendsWs', obj: window.startFriendsWs },
                { name: 'window.debugWebSocket', obj: window.debugWebSocket },
                { name: 'localStorage.wc_token', obj: localStorage.getItem('wc_token') }
            ];
            
            let allGood = true;
            
            checks.forEach(check => {
                if (check.obj) {
                    log(`‚úÖ ${check.name}: –¥–æ—Å—Ç—É–ø–µ–Ω (${typeof check.obj})`, 'success');
                } else {
                    log(`‚ùå ${check.name}: –ù–ï–î–û–°–¢–£–ü–ï–ù`, 'error');
                    allGood = false;
                }
            });
            
            if (allGood) {
                updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ appState
                if (window.appState) {
                    const state = window.appState;
                    const stateInfo = {
                        token: !!state.token,
                        friendsWs: !!state.friendsWs,
                        friendsWsConnecting: state.friendsWsConnecting,
                        wsReconnectAttempts: state.wsReconnectAttempts,
                        accountId: !!state.accountId
                    };
                    
                    document.getElementById('state').innerHTML = `
<strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ appState:</strong><br>
‚Ä¢ token: ${stateInfo.token ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}<br>
‚Ä¢ friendsWs: ${stateInfo.friendsWs ? '‚úÖ —Å–æ–∑–¥–∞–Ω' : '‚ùå –Ω–µ —Å–æ–∑–¥–∞–Ω'}<br>
‚Ä¢ friendsWsConnecting: ${stateInfo.friendsWsConnecting ? 'üîÑ –¥–∞' : '‚è∏Ô∏è –Ω–µ—Ç'}<br>
‚Ä¢ wsReconnectAttempts: ${stateInfo.wsReconnectAttempts}<br>
‚Ä¢ accountId: ${stateInfo.accountId ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}
                    `;
                }
            } else {
                updateStatus('–ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π', 'error');
            }
        }
        
        function checkWebSocket() {
            log('üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ WebSocket...', 'info');
            
            if (typeof window.debugWebSocket === 'function') {
                try {
                    const wsInfo = window.debugWebSocket();
                    log(`WebSocket —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${wsInfo.wsState}`, wsInfo.wsState === 'OPEN' ? 'success' : 'warning');
                    log(`Connecting —Ñ–ª–∞–≥: ${wsInfo.connecting}`, wsInfo.connecting ? 'warning' : 'success');
                    log(`–ü–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${wsInfo.reconnectAttempts}`, 'info');
                } catch (e) {
                    log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ WebSocket: ${e.message}`, 'error');
                }
            } else {
                log('debugWebSocket —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
            }
        }
        
        function manualInit() {
            log('üöÄ –ü–æ–ø—ã—Ç–∫–∞ —Ä—É—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket...', 'info');
            
            if (typeof window.startFriendsWs === 'function') {
                try {
                    window.startFriendsWs();
                    log('startFriendsWs –≤—ã–∑–≤–∞–Ω–∞', 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        if (window.appState && window.appState.friendsWs) {
                            log('‚úÖ WebSocket —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                            updateStatus('WebSocket –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                        } else {
                            log('‚ùå WebSocket –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è', 'error');
                            updateStatus('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket', 'error');
                        }
                    }, 3000);
                } catch (e) {
                    log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${e.message}`, 'error');
                }
            } else {
                log('startFriendsWs —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
            }
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').innerHTML = '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã...';
            document.getElementById('state').innerHTML = '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ';
            updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ...', 'info');
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                log('‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...', 'info');
                checkInitialization();
            }, 2000);
        });
        
        // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏ JavaScript
        window.addEventListener('error', (e) => {
            log(`‚ùå JS Error: ${e.message} –≤ ${e.filename}:${e.lineno}`, 'error');
        });
        
        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –º–æ–¥—É–ª–µ–π
        window.addEventListener('unhandledrejection', (e) => {
            log(`‚ùå Promise Error: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>