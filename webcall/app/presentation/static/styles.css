/* ======= THEME TOKENS ======= */
:root{
  --bg:#060913;
  --surface:#0a1020;
  --card:#0b1220;
  --text:#e6f0ff;
  --muted:#9aa3b2;

  --primary:#7c3aed;   /* violet */
  --primary-2:#06b6d4; /* cyan */
  --success:#22c55e;
  --danger:#ef4444;
  --warning:#f59e0b;

  --border:#1a2236;
  --radius:14px;
  --ring:rgba(124,58,237,0.35);
  --ring-2:rgba(6,182,212,0.25);

  --shadow-lg: 0 20px 60px rgba(0,0,0,.45);
  --shadow-md: 0 10px 40px rgba(0,0,0,.30);
  --shadow-sm: 0 6px 24px rgba(0,0,0,.2);

  --grad: linear-gradient(100deg,var(--primary),var(--primary-2));
  --grad-soft: linear-gradient(160deg,rgba(124,58,237,.18),rgba(6,182,212,.14));
}

/* Dark mode tokens (если у вас есть переключатель темы – логика уже в JS) */
body.dark{
  /* Зелёно-чёрная неоновая тема */
  --bg:#040907;            /* почти чёрный с зелёным подтоном */
  --surface:#06120d;       /* тёмная поверхность */
  --card:#082017;          /* карточки чуть светлее */
  --text:#e3fcef;          /* мягкий зеленоватый белый */
  --muted:#8aa99a;         /* приглушённый серо-зелёный */
  --primary:#10b981;       /* зелёный (tailwind emerald 500) */
  --primary-2:#34d399;     /* более светлый акцент */
  --border:#123a2b;        /* зеленоватая граница */
  --ring:rgba(16,185,129,0.50);
  --ring-2:rgba(52,211,153,0.30);
  --grad: linear-gradient(110deg,#10b981,#34d399);
  --grad-soft: linear-gradient(160deg,rgba(16,185,129,.18),rgba(52,211,153,.14));
  /* Фоновая подсветка перекрашивается зелёной гаммой */
  background:
    radial-gradient(1100px 520px at 12% -8%, rgba(16,185,129,0.18), transparent),
    radial-gradient(900px 520px at 100% 12%, rgba(52,211,153,0.14), transparent),
    linear-gradient(180deg,#04120c 0%,#061c14 100%);
}

/* Red theme: более радикальная цветовая палитра с красными оттенками */
/* theme-red удалён из активного цикла переключения; блок стилизатора убран */
body.theme-red{
  --bg:#1a0507;
  --surface:#25080c;
  --card:#2d0c10;
  --text:#ffecec;
  --muted:#f19999;
  --primary:#ff3b30;
  --primary-2:#ff7a45;
  --success:#22c55e;
  --danger:#ff4242;
  --warning:#ff9800;
  --border:#3a1116;
  --ring:rgba(255,59,48,0.45);
  --ring-2:rgba(255,122,69,0.30);
  --grad: linear-gradient(120deg,#ff3b30,#ff7a45);
  --grad-soft: linear-gradient(160deg,rgba(255,59,48,.18),rgba(255,122,69,.14));
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(255,59,48,0.25), transparent),
    radial-gradient(1000px 600px at 100% 10%, rgba(255,122,69,0.20), transparent),
    linear-gradient(180deg,#1a0507 0%,#2d0c10 100%);
}

/* ======= GLOBAL ======= */
html,body{height:100%}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,0.20), transparent),
    radial-gradient(1000px 600px at 100% 10%, rgba(6,182,212,0.15), transparent),
    linear-gradient(180deg,#070a14 0%,#0b1220 100%);
  accent-color: var(--primary);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding-bottom: env(safe-area-inset-bottom, 0); /* Safe area support */
}

/* Мягкая диффузная подсветка фоном при скролле */
body::before{
  content:"";
  position:fixed; inset:-20%;
  background:radial-gradient(60% 40% at 20% 0%, rgba(124,58,237,.10), transparent 60%),
             radial-gradient(60% 40% at 80% 10%, rgba(6,182,212,.08), transparent 60%);
  filter: blur(40px);
  z-index:-1;
  pointer-events:none;
}

/* Futuristic spiderweb canvas */
#fx-web-canvas{z-index:0;}
body,html{background-attachment:fixed}

/* ======= PERMISSIONS BANNER ======= */
#permBanner{display:none;margin-bottom:12px;display:none}
#permBanner .warn{
  background:rgba(255,176,0,0.10);
  border:1px solid color-mix(in srgb, var(--warning) 60%, transparent);
  padding:8px 12px;
  border-radius:10px;
  font-size:13px;
  line-height:1.35;
  display:flex;
  gap:6px;
  align-items:flex-start;
  position:relative;
}
#permBanner .warn::before{
  content:"!";
  font-weight:600;
  color:var(--warning);
  width:18px;height:18px;
  display:inline-flex;align-items:center;justify-content:center;
  background:rgba(255,176,0,0.15);
  border-radius:6px;
  font-size:12px;
}

/* Адаптация для prefers-reduced-motion */
@media (prefers-reduced-motion: reduce){
  *{animation:none !important; transition:none !important}
}

/* Контейнер */
.container{max-width:1200px;margin:0 auto;padding:16px}

/* ======= HEADER ======= */
.app-header{
  position:sticky; top:0; z-index:10;
  backdrop-filter: blur(10px);
  background: color-mix(in srgb, var(--surface) 65%, transparent);
  border-bottom:1px solid var(--border);
}
.header-inner{display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px}
.logo{
  display:inline-grid;place-items:center;
  width:26px;height:26px;border-radius:50%;
  background: conic-gradient(from 180deg,var(--primary),var(--primary-2),var(--primary));
  box-shadow: 0 0 24px rgba(124,58,237,.5), inset 0 0 18px rgba(255,255,255,.08);
  animation: spin-slow 14s linear infinite;
}
@keyframes spin-slow { to { transform: rotate(360deg) } }
.title{font-weight:800;letter-spacing:.4px}

/* ===== USER BADGE ===== */
.actions{display:flex;align-items:center;gap:10px}
.user-badge{
  --ub-bg: linear-gradient(160deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px 6px 8px;
  border-radius: 40px;
  font-size:13px; font-weight:500;
  background: var(--ub-bg);
  border:1px solid color-mix(in srgb, var(--border) 70%, var(--primary) 30%);
  position:relative;
  line-height:1.1;
  box-shadow: 0 4px 14px rgba(0,0,0,.30), inset 0 0 0 1px rgba(255,255,255,.05);
  backdrop-filter: blur(6px) saturate(140%);
  -webkit-backdrop-filter: blur(6px) saturate(140%);
  letter-spacing:.2px;
  animation: badge-in .35s cubic-bezier(.32,1.4,.32,1);
}
@keyframes badge-in { from { opacity:0; transform: translateY(-4px) scale(.92); } to { opacity:1; transform:none; } }
.user-badge__icon{ font-size:15px; filter: drop-shadow(0 0 6px rgba(124,58,237,.55)); }
.user-badge__name{ max-width:140px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
@media (max-width:640px){ .user-badge__name{ max-width:90px } }

/* ======= LAYOUT ======= */
.app-main{display:flex;flex-direction:column;gap:16px}
.panel{background:transparent;border-radius:var(--radius)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:960px){.grid-2{grid-template-columns:1fr}}

/* ======= CARD (стеклянная карта с переливом) ======= */
.card{
  position:relative;
  background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow: var(--shadow-md);
  transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
}
.card:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
  border-color: color-mix(in srgb, var(--border) 70%, var(--primary) 30%);
}
/* Градиентная окантовка (тонкая) */
.card::before{
  content:"";
  position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  padding:1px;
  background: linear-gradient(140deg, rgba(124,58,237,.45), rgba(6,182,212,.35));
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
}

/* Заголовки карт */
.card h2{margin:0 0 12px 0;font-size:18px;letter-spacing:.2px}

/* ======= FORMS ======= */
.row{display:flex;gap:8px;align-items:center}
label{display:flex;flex-direction:column;gap:6px;font-size:14px;color:var(--muted)}
input, .sel, select{
  background: var(--card);
  border:1px solid var(--border);
  color:var(--text);
  padding:10px 12px;
  border-radius:10px;
  outline:none;
  transition: border-color .2s ease, box-shadow .2s ease, transform .05s ease;
}
input:focus, .sel:focus, select:focus{
  border-color:transparent;
  box-shadow: 0 0 0 .22rem var(--ring), 0 0 0 .44rem var(--ring-2);
}
input:active{ transform: scale(.995) }

.sel, select{
  appearance:none;
  padding-right:36px;
  background-image: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)),
    url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%23a7b0c2' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat, no-repeat;
  background-position: center left, right 10px center;
  background-size: 100% 100%, 20px 20px;
}

/* Сетка формы */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-grid .row{grid-column:1/-1;display:flex;gap:8px;flex-wrap:wrap}
.form-grid .col{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between}
@media(max-width:640px){ .form-grid{grid-template-columns:1fr} }

/* ======= BUTTONS ======= */
.btn{
  --btn-bg:#0f172a;
  display:inline-flex;align-items:center;justify-content:center;
  padding:10px 14px;border-radius:12px;
  border:1px solid var(--border); background:var(--btn-bg); color:var(--text);
  font-size:14px; line-height:1;
  cursor:pointer; user-select:none;
  transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
  position:relative; overflow:hidden;
}
.btn::after{ /* блик */
  content:""; position:absolute; inset:-1px; pointer-events:none;
  background: linear-gradient(120deg, rgba(255,255,255,.12), transparent 40%, transparent 60%, rgba(255,255,255,.10));
  transform: translateX(-100%);
  transition: transform .6s ease;
}
.btn:hover::after{ transform: translateX(0) }

.btn:hover{ border-color:#2a3347; box-shadow:0 0 0 .35rem rgba(124,58,237,0.10) }
.btn:active{ transform: translateY(1px) scale(.99) }
.btn:disabled{opacity:.6;cursor:not-allowed}

.btn.ghost{ background: transparent; border-color: transparent }
.btn.ghost:hover{ background: rgba(255,255,255,0.08) }

.btn.primary{
  border-color: transparent;
  background: var(--grad);
  box-shadow: 0 8px 28px rgba(124,58,237,.25);
}
.btn.primary:hover{ box-shadow: 0 10px 36px rgba(124,58,237,.35) }

/* Активное состояние для кнопок камеры/экрана */
.btn.btn-media-active{
  border-color: var(--primary);
  background: linear-gradient(160deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
  box-shadow: 0 0 0 .25rem rgba(124,58,237,0.18), inset 0 0 0 1px rgba(255,255,255,.06);
  position: relative;
}
.btn.btn-media-active::before{
  content: "●";
  position:absolute;top:4px;right:6px;font-size:10px;line-height:1;color:var(--primary-2);
  filter: drop-shadow(0 0 4px color-mix(in srgb, var(--primary) 60%, transparent));
}

.btn.success{ background: linear-gradient(100deg, var(--success), #16a34a); border-color:transparent }
.btn.danger{ background: linear-gradient(100deg, var(--danger), #dc2626); border-color:transparent }

/* Chat unread badge (используем ::before, чтобы не конфликтовать с .btn::after подсветкой) */
.btn.chat-btn.has-unread{
  /* Чуть увеличим правый верхний отступ, чтобы кружок не накладывался на текст */
  padding-right: 16px;
  padding-top: 14px;
}
.btn.chat-btn.has-unread::before{
  content: "";
  position: absolute;
  top: 2px; right: 2px; /* В самый угол */
  width: 12px; height: 12px;
  background: var(--danger);
  border-radius: 50%;
  box-shadow: 0 0 0 2px var(--bg), 0 0 6px rgba(239,68,68,.8);
  pointer-events: none;
  /* Если захотим показывать число: заменить content: attr(data-unread); и добавить стили ниже */
}

/* XS вариант, если понадобится */
.btn.xs{padding:6px 10px;font-size:12px;border-radius:8px}

/* ======= VIDEO ======= */
.video-wrap{
  position:relative; aspect-ratio:16/9; background:#000;
  border-radius:12px; overflow:hidden; border:1px solid var(--border);
  box-shadow: var(--shadow-sm);
}
video{width:100%;height:100%;object-fit:cover;display:block}

/* Мини-индикатор шаринга экрана */
.share-badge{
  position:absolute; left:8px; top:8px; z-index:5;
  background: linear-gradient(140deg, rgba(16,185,129,.20), rgba(16,185,129,.08));
  color: var(--text);
  font-size:12px; font-weight:600; letter-spacing:.3px;
  padding:6px 10px; border-radius:20px;
  border:1px solid color-mix(in srgb, var(--primary) 60%, var(--border));
  display:inline-flex; align-items:center; gap:6px;
  box-shadow: 0 4px 18px rgba(0,0,0,.45), 0 0 0 .35rem rgba(16,185,129,0.18);
  backdrop-filter: blur(6px) saturate(140%);
  -webkit-backdrop-filter: blur(6px) saturate(140%);
  animation: badge-pop .35s cubic-bezier(.32,1.4,.32,1);
}
body.theme-red .share-badge{ background: linear-gradient(140deg, rgba(255,59,48,.25), rgba(255,59,48,.10)); box-shadow:0 4px 18px rgba(0,0,0,.45), 0 0 0 .35rem rgba(255,59,48,0.22); }
@keyframes badge-pop { from { opacity:0; transform: translateY(-4px) scale(.92); } to { opacity:1; transform:none; } }

/* ======= PEERS GRID ======= */
.peers-grid{
  display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:16px;
}

/* ======= TILE (плитка участника) ======= */
.tile{
  position:relative; border-radius:12px; overflow:hidden;
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
  border:1px solid var(--border);
  animation: tile-in .28s ease both;
  transition: transform .18s ease, box-shadow .18s ease, border-color .2s ease;
}
.tile:hover{
  transform: translateY(-2px);
  box-shadow: 0 0 0 .28rem rgba(6,182,212,.09) inset, var(--shadow-md);
}
@keyframes tile-in{ from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:none } }

.tile .media{ aspect-ratio:16/10; background:#0b1220 }
.tile .media video{ width:100%; height:100%; object-fit:cover; }
.tile .hud{
  position:absolute; left:0; right:0; bottom:0;
  padding:10px 10px 12px;
  background: linear-gradient(0deg, rgba(0,0,0,.75), transparent 70%);
  display:flex; flex-direction:column; gap:8px;
}
.tile .hud .name{ font-weight:600; font-size:14px; text-shadow:0 1px 2px rgba(0,0,0,.6) }
.tile .hud .level{
  height:6px; background:rgba(255,255,255,.12);
  border-radius:4px; overflow:hidden;
  border:1px solid rgba(255,255,255,.08);
}
.tile .hud .level-bar{
  width:100%; height:100%;
  background: linear-gradient(90deg, var(--primary-2), var(--primary));
  transform-origin:left; transform: scaleX(0);
  transition: transform .09s linear;
  box-shadow: 0 0 12px rgba(6,182,212,.35);
}

/* Сетевой статус рамкой (из вашей логики data-net) */
.tile[data-net="connecting"]{ border-color: var(--warning) }
.tile[data-net="connected"]{ border-color: var(--success) }
.tile[data-net="failed"]{ border-color: var(--danger) }

/* ======= RANGE (громкость) ======= */
input[type="range"]{
  -webkit-appearance:none; appearance:none; width:120px; height:24px; background:transparent;
}
input[type="range"]::-webkit-slider-runnable-track{
  height:6px; background:rgba(255,255,255,.18);
  border-radius:6px; border:1px solid rgba(255,255,255,.08);
}
input[type="range"]::-moz-range-track{
  height:6px; background:rgba(255,255,255,.18);
  border-radius:6px; border:1px solid rgba(255,255,255,.08);
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none; appearance:none;
  width:18px; height:18px; border-radius:50%;
  margin-top:-7px;
  background: var(--grad);
  border:0; box-shadow: 0 4px 14px rgba(124,58,237,.35);
  transition: transform .12s ease;
}
input[type="range"]::-webkit-slider-thumb:hover{ transform: scale(1.06) }
input[type="range"]::-moz-range-thumb{
  width:18px; height:18px; border:0; border-radius:50%;
  background: var(--grad);
  box-shadow: 0 4px 14px rgba(124,58,237,.35);
}

/* ======= CHAT ======= */
.chat-box{
  height:180px; overflow-y:auto;
  border:1px solid var(--border); border-radius:10px;
  padding:10px; margin-bottom:8px; font-size:14px;
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
  box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
}

  /* ======= MOBILE ADAPTATIONS ======= */
  @media (max-width: 760px){
    .grid-2{grid-template-columns:1fr !important}
    .app-main{gap:12px}
    .card{padding:14px}
    .btn{padding:12px 16px;font-size:15px;border-radius:14px}
    input, .sel, select{padding:12px 14px;font-size:15px}
    #friendsCard .list-item, #visitedRooms .list-item{padding:10px 8px}
    #directMessages, #chat{height:auto;max-height:38vh}
    .chat-box{font-size:14px;line-height:1.35}
    .tile video{max-height:32vh}
    .peers-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
    body{font-size:15px}
    .app-header .actions .btn{padding:8px 10px}
  }

  @media (max-width:480px){
    #directMessages, #chat{max-height:44vh}
    .btn{font-size:14px;padding:11px 14px}
    input, .sel, select{font-size:14px}
  }
.chat-input{ display:flex; gap:8px }
.chat-input input{
  flex:1;
}
/* Chat lines (bubbles) */
.chat-line{display:flex;flex-direction:column;max-width:80%;margin:4px 0;animation:fade-in .18s ease}
.chat-line .who{font-size:11px;letter-spacing:.3px;opacity:.75;margin:0 4px 3px 4px}
.chat-line .bubble{padding:10px 12px;border-radius:14px;font-size:14px;line-height:1.35;white-space:pre-wrap;word-break:break-word;position:relative;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--border);box-shadow:0 4px 14px rgba(0,0,0,.25)}
.chat-line.self{margin-left:auto;align-items:flex-end}
.chat-line.self .bubble{background:var(--grad);color:#fff;border-color:transparent;box-shadow:0 4px 18px rgba(124,58,237,.45)}
.chat-line.other{align-items:flex-start}
.chat-line.other .bubble{background:linear-gradient(160deg,rgba(255,255,255,.08),rgba(255,255,255,.04));}
@keyframes fade-in{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}

/* ======= BUTTONS GRID (2x3) ======= */
.controls-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;align-items:stretch}
.controls-grid .btn{width:100%}
@media(max-width:640px){.controls-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}}

/* ======= LOGS ======= */
.logs{
  min-height:120px; max-height:240px; overflow:auto;
  background: #0b1220;
  border:1px solid var(--border);
  border-radius:10px; padding:8px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size:13px; color:#cbd5e1;
}
.log-line{ display:flex; gap:8px }
.log-line .time{ color:#7dd3fc }
.log-line .msg{ flex:1; white-space:pre-wrap; word-break:break-word }

/* ======= SIMPLE LIST ======= */
.list{ display:flex; flex-direction:column; gap:8px }
.list-item{ display:flex; gap:12px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); flex-wrap:wrap }
.list-item .grow{ flex:1; min-width:0 }
.list-item-actions{ display:flex; gap:8px; flex-wrap:wrap }

/* Кнопка переключения темы в виде цветной точки */
#btnToggleTheme.theme-dot{ width:30px; height:30px; padding:0; font-size:20px; line-height:1; border-radius:50%; background:var(--card); border:1px solid var(--border); color:var(--primary); text-shadow:0 0 8px color-mix(in srgb, var(--primary) 65%, transparent); box-shadow:0 2px 8px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05); display:inline-flex; align-items:center; justify-content:center; }
#btnToggleTheme.theme-dot:hover{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); }
body.dark #btnToggleTheme.theme-dot{ color:var(--primary); text-shadow:0 0 10px rgba(16,185,129,.6) }
body.theme-red #btnToggleTheme.theme-dot{ color:var(--primary); text-shadow:0 0 10px rgba(255,59,48,.65) }

/* Мобильный фикс перекрытия кнопки "Позвонить" и email в списке друзей */
@media (max-width:520px){
  #friendsCard .list-item{ flex-direction:column; align-items:stretch; }
  #friendsCard .list-item .grow{ width:100%; }
  #friendsCard .list-item .list-item-actions{ width:100%; justify-content:flex-start; }
  #friendsCard .list-item .list-item-actions .btn{ flex:1 1 auto; min-width:110px; }
  #friendsCard .list-item .muted.small{ word-break:break-word; }
}
.bold{ font-weight:600 }
.small{ font-size:12px }
.muted{ color: var(--muted) }

/* ======= FRIEND STATUS DOT ======= */
.status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle;box-shadow:0 0 0 2px rgba(0,0,0,.35),0 0 6px rgba(0,0,0,.4);background:#666;position:relative;top:-1px}
.status-dot.online{background:#10b981;box-shadow:0 0 0 2px rgba(0,0,0,.3),0 0 0 4px rgba(16,185,129,0.15),0 0 8px rgba(16,185,129,.8)}
.status-dot.offline{background:#555;opacity:.65}

/* ======= LOCAL VIDEO CARD ======= */
.video-card .video-wrap{ background:#000 }
.video-card .video-wrap::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background: linear-gradient(0deg, rgba(0,0,0,.55), transparent 60%);
}

/* ======= SCROLLBARS ======= */
.chat-box::-webkit-scrollbar,
.logs::-webkit-scrollbar,
.peers-grid::-webkit-scrollbar{ width:10px; height:10px }
.chat-box::-webkit-scrollbar-thumb,
.logs::-webkit-scrollbar-thumb,
.peers-grid::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.12));
  border-radius:10px; border:2px solid transparent; background-clip:content-box;
}

/* ======= ACCESSIBILITY ======= */
:focus-visible{
  outline: none;
  box-shadow: 0 0 0 .22rem var(--ring), 0 0 0 .44rem var(--ring-2);
  border-radius: 12px;
}

/* ======= AUTH FIELD ERRORS ======= */
.input-error { border-color: var(--danger) !important; outline:1px solid var(--danger); }
.input-error:focus { box-shadow: 0 0 0 .22rem rgba(239,68,68,0.35), 0 0 0 .44rem rgba(239,68,68,0.18) !important; }

/* ======= IN-CALL LAYOUT ======= */
.app-in-call{ display:block; }
@media (max-width: 720px){
  .controls-grid{ grid-template-columns:repeat(2,1fr); }
  .peers-grid{ grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
  .chat-box{ height: 160px; }
}
@media (min-width: 1280px){
  .chat-box{ height: 220px; }
}

@media (max-width: 760px){
  .chat-input{flex-wrap:wrap}
  .chat-input .btn{width:100%}
}

/* ======= INCOMING CALL MODAL ======= */
.wc-modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:200; }
.wc-modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(6px); }
.wc-modal-dialog{
  position:relative; z-index:1; width:clamp(280px, 90vw, 420px);
  background: linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--border);
  border-radius: 22px; padding:28px 26px 24px;
  box-shadow: 0 18px 60px rgba(0,0,0,.55), 0 0 0 .5rem rgba(124,58,237,.10);
  animation: wc-modal-in .32s cubic-bezier(.32,1.4,.32,1) both;
}
@keyframes wc-modal-in { from { opacity:0; transform:translateY(18px) scale(.96);} to { opacity:1; transform:none;} }
.wc-modal-body{ display:flex; gap:18px; align-items:center; margin-bottom:22px; }
.wc-modal-icon{ font-size:44px; filter: drop-shadow(0 4px 14px rgba(124,58,237,.45)); }
.wc-modal-text{ display:flex; flex-direction:column; gap:6px; }
.wc-modal-title{ font-size:18px; font-weight:700; letter-spacing:.3px; }
.wc-modal-sub{ font-size:14px; color:var(--muted); }
.wc-modal-actions{ display:flex; gap:14px; justify-content:flex-end; }
.wc-modal-actions .btn{ flex:1; font-size:15px; padding:14px 16px; }
@media (max-width:520px){
  .wc-modal-dialog{ padding:22px 20px 20px; border-radius:18px; }
  .wc-modal-icon{ font-size:38px; }
  .wc-modal-actions{ flex-direction:column; }
}

/* Swipe подсказки */
.wc-modal-actions .btn{
  position:relative;
  will-change: transform, opacity;
}
.wc-modal-actions .btn.swipe-armed{
  box-shadow: 0 0 0 .25rem rgba(255,255,255,.06), 0 0 0 .55rem rgba(124,58,237,.18);
  outline:1px solid color-mix(in srgb, var(--primary) 55%, transparent);
}
.wc-modal-actions .btn.swipe-armed::before{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:linear-gradient(120deg, rgba(124,58,237,.35), rgba(6,182,212,.30));
  mix-blend-mode:overlay; opacity:.55; border-radius:inherit;
  animation: swipe-pulse 1s ease-in-out infinite alternate;
}
@keyframes swipe-pulse { from { opacity:.35; } to { opacity:.75; } }

/* ======= TOASTS ======= */
.wc-toast{
  min-width: 220px;
  max-width: 360px;
  background: linear-gradient(160deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  border:1px solid var(--border);
  color: var(--text);
  font-size: 14px;
  padding:12px 14px;
  border-radius:14px;
  box-shadow: var(--shadow-md), 0 0 0 .35rem rgba(124,58,237,0.08);
  position:relative;
  animation: toast-in .35s cubic-bezier(.32,1.4,.32,1) both;
  backdrop-filter: blur(8px);
}
.wc-toast-success{ border-color: color-mix(in srgb, var(--success) 60%, var(--border)); }
.wc-toast-error{ border-color: color-mix(in srgb, var(--danger) 60%, var(--border)); }
@keyframes toast-in { from { opacity:0; transform: translateY(-8px) scale(.95); } to { opacity:1; transform:none; } }
.wc-toast.leaving{ animation: toast-out .32s ease forwards; }
@keyframes toast-out { to { opacity:0; transform: translateY(-6px) scale(.96); } }

/* ======= DEBUG PANEL ======= */
#debugPanel {
  border: 2px solid rgba(124,58,237,0.3);
  background: linear-gradient(160deg, rgba(124,58,237,0.08), rgba(6,182,212,0.04));
}

.debug-status {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 13px;
  line-height: 1.4;
}

.debug-status div {
  margin-bottom: 4px;
}

.debug-status div:last-child {
  margin-bottom: 0;
}

.debug-status span {
  color: var(--primary-2);
  font-weight: 500;
}

#debugFriendsMessages,
#debugCallLog {
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.3;
  background: rgba(0,0,0,0.2);
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow-y: auto;
  padding: 6px 8px;
}

#debugFriendsMessages .debug-msg,
#debugCallLog .debug-msg {
  margin-bottom: 2px;
  padding: 2px 4px;
  border-radius: 3px;
}

#debugFriendsMessages .debug-msg.incoming {
  background: rgba(34,197,94,0.1);
  border-left: 2px solid var(--success);
}

#debugFriendsMessages .debug-msg.outgoing {
  background: rgba(239,68,68,0.1);
  border-left: 2px solid var(--danger);
}

#debugCallLog .debug-msg.call-event {
  background: rgba(124,58,237,0.1);
  border-left: 2px solid var(--primary);
}

.debug-timestamp {
  color: var(--muted);
  font-size: 11px;
  margin-right: 6px;
}

/* ======= RESPONSIVE REFINEMENTS (ADDED) ======= */
/* Сетка участников: упорядочим брейки, чтобы не было конфликтов 220px/140px */
@media (max-width: 900px){
  .peers-grid{ grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); }
}
@media (max-width: 760px){
  /* Уже есть общее уменьшение – подправим peers-grid */
  .peers-grid{ grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); }
}
@media (max-width: 640px){
  .peers-grid{ grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); }
  .tile .media{ aspect-ratio:4/3; }
}
@media (max-width: 520px){
  .peers-grid{ grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:10px; }
  .tile .media{ aspect-ratio:4/3; }
  .tile .hud{ padding:8px 8px 10px; gap:6px; }
  .tile .hud .name{ font-size:13px; }
}
@media (max-width: 430px){
  .peers-grid{ grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:8px; }
  .tile .media{ aspect-ratio:1/1; }
  .tile .hud{ padding:6px 6px 8px; }
  .tile .hud .level{ height:5px; }
  .tile .hud .name{ font-size:12px; }
}

/* Header / actions адаптация */
@media (max-width: 720px){
  .header-inner{ flex-wrap:wrap; row-gap:8px; }
  .app-header .actions{ flex-wrap:wrap; justify-content:flex-end; }
}
@media (max-width: 560px){
  .app-header .actions .btn{ padding:8px 10px; font-size:13px; }
  .user-badge{ padding:5px 9px; }
}
@media (max-width: 430px){
  .title{ font-size:15px; }
  .app-header .actions .btn{ padding:7px 9px; font-size:12px; }
  /* Скрыть текст на кнопке выхода оставив иконку через data-attr, если захотите добавить позже */
  #btnLogout{ white-space:nowrap; }
  #btnLogout::after{ content:""; }
}

/* Уменьшение общих отступов */
@media (max-width: 600px){
  .container{ padding:12px; }
  .card{ padding:14px; }
}
@media (max-width: 430px){
  .container{ padding:10px; }
  .card{ padding:12px; }
}

/* Динамическая высота чатов: предотвращаем наложение на элементы управления */
@media (max-height: 900px){
  .chat-box{ max-height: 260px; }
}
@media (max-height: 780px){
  .chat-box{ max-height: 220px; }
}
@media (max-width: 640px){
  /* На очень узких и невысоких устройствах ограничим относительным vh */
  .chat-box, #directMessages{ max-height: min(44vh, 300px); }
}
@media (max-width: 430px){
  .chat-box, #directMessages{ max-height: min(48vh, 260px); }
}

