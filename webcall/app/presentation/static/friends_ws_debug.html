<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCall - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Friends WebSocket</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .controls { margin: 20px 0; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç WebCall - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Friends WebSocket</h1>
        
        <div id="status" class="status info">–ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ...</div>
        
        <div class="controls">
            <button class="button" onclick="checkFriendsWS()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Friends WS</button>
            <button class="button" onclick="testFriendsWS()">üì§ –¢–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</button>
            <button class="button success" onclick="startListening()">üëÇ –ù–∞—á–∞—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ</button>
            <button class="button" onclick="getStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </div>
        
        <div class="grid">
            <div>
                <h3>üìã –õ–æ–≥–∏ WebSocket</h3>
                <div id="logs" class="log">–û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏...</div>
            </div>
            <div>
                <h3>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div id="stats" class="log">–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
            </div>
        </div>
        
        <div>
            <h3>üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
            <p><strong>–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤:</strong></p>
            <ol>
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —É <strong>–ø–æ–ª—É—á–∞—Ç–µ–ª—è</strong></li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Friends WS" - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å OPEN</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ"</li>
                <li>–° –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞/–±—Ä–∞—É–∑–µ—Ä–∞ –∏–Ω–∏—Ü–∏–∏—Ä—É–π—Ç–µ –∑–≤–æ–Ω–æ–∫</li>
                <li>–°–º–æ—Ç—Ä–∏—Ç–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö</li>
            </ol>
        </div>
    </div>

    <script>
        let logs = [];
        let listening = false;
        let messageCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ timestamp, message, type });
            
            const logsDiv = document.getElementById('logs');
            const color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : type === 'success' ? '#28a745' : '#333';
            logsDiv.innerHTML += `<div style="color: ${color}">${logEntry}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function checkFriendsWS() {
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Friends WebSocket...', 'info');
            
            if (!window.appState) {
                log('‚ùå window.appState –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                updateStatus('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'error');
                return;
            }
            
            const ws = window.appState.friendsWs;
            const connecting = window.appState.friendsWsConnecting;
            
            if (!ws) {
                log('‚ùå Friends WebSocket –Ω–µ —Å–æ–∑–¥–∞–Ω', 'error');
                if (connecting) {
                    log('‚è≥ –ù–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...', 'warning');
                    updateStatus('WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...', 'warning');
                } else {
                    updateStatus('WebSocket –Ω–µ —Å–æ–∑–¥–∞–Ω', 'error');
                }
                return;
            }
            
            const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
            const state = states[ws.readyState] || 'UNKNOWN';
            
            log(`üîó WebSocket —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${state} (${ws.readyState})`, state === 'OPEN' ? 'success' : 'warning');
            log(`üì° URL: ${ws.url}`, 'info');
            
            if (state === 'OPEN') {
                updateStatus('Friends WebSocket –≥–æ—Ç–æ–≤!', 'success');
                updateStats();
            } else {
                updateStatus(`WebSocket –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏: ${state}`, 'warning');
            }
        }
        
        function testFriendsWS() {
            if (typeof window.testFriendsWS === 'function') {
                const result = window.testFriendsWS();
                if (result) {
                    log('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                } else {
                    log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
                }
            } else {
                log('‚ùå –§—É–Ω–∫—Ü–∏—è testFriendsWS –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
            }
        }
        
        function startListening() {
            if (listening) {
                log('‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è...', 'info');
                listening = false;
                return;
            }
            
            log('üëÇ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...', 'success');
            listening = true;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            const interval = setInterval(() => {
                if (!listening) {
                    clearInterval(interval);
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
                if (window.__FRIENDS_WS_STATS) {
                    const stats = window.__FRIENDS_WS_STATS;
                    if (stats.total > messageCount) {
                        const newMessages = stats.total - messageCount;
                        log(`üì® –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: ${newMessages}`, 'success');
                        messageCount = stats.total;
                        updateStats();
                    }
                }
            }, 2000);
            
            updateStatus('–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ...', 'info');
        }
        
        function getStats() {
            updateStats();
        }
        
        function updateStats() {
            const statsDiv = document.getElementById('stats');
            
            let content = '<strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</strong><br>';
            
            if (window.appState?.friendsWs) {
                const ws = window.appState.friendsWs;
                const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
                const state = states[ws.readyState] || 'UNKNOWN';
                content += `‚Ä¢ WebSocket: ${state}<br>`;
                content += `‚Ä¢ URL: ${ws.url}<br>`;
            } else {
                content += '‚Ä¢ WebSocket: –ù–ï –°–û–ó–î–ê–ù<br>';
            }
            
            content += `‚Ä¢ Connecting: ${window.appState?.friendsWsConnecting || false}<br>`;
            content += `‚Ä¢ –ü–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${window.appState?.wsReconnectAttempts || 0}<br><br>`;
            
            if (window.__FRIENDS_WS_STATS) {
                const stats = window.__FRIENDS_WS_STATS;
                content += '<strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong><br>';
                content += `‚Ä¢ –í—Å–µ–≥–æ: ${stats.total}<br>`;
                content += '‚Ä¢ –ü–æ —Ç–∏–ø–∞–º:<br>';
                Object.entries(stats.byType).forEach(([type, count]) => {
                    content += `&nbsp;&nbsp;- ${type}: ${count}<br>`;
                });
            } else {
                content += '<strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö<br>';
            }
            
            statsDiv.innerHTML = content;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            
            setTimeout(() => {
                checkFriendsWS();
            }, 2000);
        });
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        setInterval(() => {
            if (window.appState?.friendsWs) {
                updateStats();
            }
        }, 10000);
    </script>
</body>
</html>