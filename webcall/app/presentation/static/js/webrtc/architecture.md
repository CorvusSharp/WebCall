# Архитектура модульного WebRTC слоя (план рефакторинга)

Этот документ описывает целевую декомпозицию текущего монолитного `WebRTCManager`.

## Текущее состояние
Один класс `WebRTCManager` (~1.4K LOC) совмещает:
1. Управление локальными медиа (микрофон / камера / экран / адаптация качества / превью / композиция Canvas).
2. Управление пирами и их жизненным циклом (создание `RTCPeerConnection`, transceiver policy, ICE restart, glare resolution, watchdog).
3. Логику протокола сигналинга (обработка offer/answer/candidates + коллизии).
4. Диагностику и метрики (audio RMS, video stats, SDP introspection, watchdog).
5. UI‑ориентированные побочные эффекты (манипуляции DOM: canvas, видео‑элемент, inline стили).

Это нарушает принцип **SRP** и затрудняет тестирование/расширение.

## Целевая декомпозиция (итеративно)
Модули (директория `./webrtc/`):

| Модуль | Ответственность | Внешний контракт |
|--------|-----------------|------------------|
| `media.js` (`MediaManager`) | Локальные устройства и треки: захват, переключение, адаптация качества, screen share | Методы `startCamera()`, `stopCamera()`, `startScreenShare()`, `stopScreenShare()`, события колбеков |
| `peers.js` (`PeerConnectionManager`) | Создание/хранение `RTCPeerConnection`, политика transceivers, ICE restart, glare, watchdog | CRUD пиров, события состояния, методы `ensurePeer`, `handleOffer/Answer/Candidate` |
| `signaling.js` (`SignalingOrchestrator`) | Высокоуровневый FSM переговоров, согласование ролей (polite/impolite), очереди glare, ретраи | Метод `handleSignal(raw)` produce actions для PeerConnectionManager |
| `tracks.js` (`TrackRouter`) | Привязка локальных треков к пирам (замена/добавление senders), слот экрана/камеры, политика up/downscale | `attachLocalTrack(kind, track)` |
| `composite.js` | Canvas PiP композиция (экран + камера) | `enable(canvas)`, `disable()` |
| `metrics.js` | Сбор локальных видео метрик и аудио RMS | Подписка на треки, колбеки обновлений |
| `diagnostics.js` | Функции инспекции (SDP, transceivers, stats) без побочных изменений | Набор чистых утилит |
| `webrtc_manager.js` | Фасад — связывает все менеджеры и сохраняет прежний публичный API | Экспорт совместимого класса |

## Принципы SOLID
* **SRP** — каждый модуль узко сфокусирован.
* **OCP** — расширения (например новая стратегия кандидатов или альтернативный анализатор уровня) добавляются новыми классами без правки фасада.
* **LSP** — мелкие интерфейсы (например стратегия адаптации качества) можно подменять.
* **ISP** — вместо одного «толстого» интерфейса WebRTC предоставляются целевые контракты (Media, Peers, Signaling...).
* **DIP** — `webrtc_manager.js` зависит от абстракций (интерфейсы стратегий), а не от конкретных реализаций.

## Стратегия миграции
1. (Этап 1 — текущий) Ввести новые файлы и перенести логику локальных медиа в `MediaManager` с минимальными зависимостями.
2. Этап 2: Извлечь управление пирами (`_ensurePeer`, ICE restart, watchdog) в `PeerConnectionManager`.
3. Этап 3: Вынести разбор сигналов (offer/answer/candidate) + glare очередь в `SignalingOrchestrator`.
4. Этап 4: Выделить композицию и метрики.
5. Этап 5: Очистить `webrtc.js`, заменить на тонкий реэкспорт `webrtc_manager.js` (обратная совместимость через прежнее имя класса).

## Критерии завершенности этапа 1
* Существующий код продолжает работать без модификации импортов.
* Добавлен `MediaManager` и документация.
* Следующий коммит может начать замену методов камеры/экрана на делегирование.

Этот файл удалится или упростится после полной миграции.
