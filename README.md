# WebCall

–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π backend + –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö WebRTC –∑–≤–æ–Ω–∫–æ–≤: FastAPI, WebSocket —Å–∏–≥–Ω–∞–ª–∏–Ω–≥, –∫–æ–º–Ω–∞—Ç—ã, —á–∞—Ç, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏, –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, –≥–∏–±–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (onion / clean) –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∞–¥–∞–ø—Ç–µ—Ä—ã (PostgreSQL, Redis, TURN/STUN).

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –≤—Ö–æ–¥ –ø–æ JWT (+ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- –ö–æ–º–Ω–∞—Ç—ã –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ WebSocket
- –°–∏–≥–Ω–∞–ª–∏–Ω–≥ –¥–ª—è WebRTC (–æ–±–º–µ–Ω SDP / ICE)
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∏—Ö —Ä–µ–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É
- –ß–∞—Ç (—Å—Ç–∏–ª—å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞: —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∞)
- –£–¥–∞–ª–µ–Ω–∏–µ ¬´–∑–∞–ª–µ–∂–∞–≤—à–∏—Ö—Å—è¬ª –ø–∏—Ä–æ–≤ (–æ—á–∏—Å—Ç–∫–∞ presence)
- Logout, –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
- Canvas ¬´–ø–∞—É—Ç–∏–Ω–∫–∞¬ª —Ñ–æ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
- TURN/STUN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## üß± –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ—ë–≤
```
 presentation (REST, WS, static)
     ‚Üì
 application (use cases, DTO)
     ‚Üì
 core (domain models, ports, services, errors)
     ‚Üì
 infrastructure (db, redis, jwt, security, messaging, ice)
```
–ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: –≤–µ—Ä—Ö–Ω–∏–µ —Å–ª–æ–∏ –∑–Ω–∞—é—Ç —Ç–æ–ª—å–∫–æ –æ –ø–æ—Ä—Ç–∞—Ö (`core.ports`). –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–Ω–µ–¥—Ä—è—é—Ç—Å—è —á–µ—Ä–µ–∑ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ `presentation.api.deps`.

## üóÇ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏
- `app/bootstrap` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è / ASGI
- `app/presentation` ‚Äî API —Ä–æ—É—Ç—ã, WebSocket—ã, —Å—Ö–µ–º—ã, –æ—à–∏–±–∫–∏, —Å—Ç–∞—Ç–∏–∫–∞
- `app/application` ‚Äî DTO –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (use-cases)
- `app/core` ‚Äî –¥–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏, –ø–æ—Ä—Ç—ã, –æ—à–∏–±–∫–∏, —Å–µ—Ä–≤–∏—Å—ã –¥–æ–º–µ–Ω–∞
- `app/infrastructure` ‚Äî –∞–¥–∞–ø—Ç–µ—Ä—ã: –ë–î, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, Redis, JWT, –ø–∞—Ä–æ–ª—å, ICE, messaging
- `alembic/` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏
- `docker/` ‚Äî Dockerfile –¥–ª—è API
- `tests/` ‚Äî –±–∞–∑–æ–≤—ã–µ –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–µ —Ç–µ—Å—Ç—ã

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|------------|--------|
| `APP_ENV` | –æ–∫—Ä—É–∂–µ–Ω–∏–µ (dev/prod) | dev |
| `HOST` / `PORT` | bind –∞–¥—Ä–µ—Å API | 0.0.0.0 / 8000 |
| `JWT_SECRET` | —Å–µ–∫—Ä–µ—Ç JWT (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω) | (—É–∫–∞–∑–∞—Ç—å –≤ .env) |
| `JWT_EXPIRES_MIN` | –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ (–º–∏–Ω) | 60 |
| `REGISTRATION_SECRET` | –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ | (—É–∫–∞–∑–∞—Ç—å –≤ .env) |
| `DATABASE_URL` | —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Postgres | postgresql+asyncpg://webcall:pwd@postgres:5432/webcall |
| `REDIS_URL` | —Å—Ç—Ä–æ–∫–∞ Redis | redis://redis:6379/0 |
| `CORS_ORIGINS` | —Å–ø–∏—Å–∫–æ–º, –∑–∞–ø—è—Ç—ã–µ | http://localhost:5173,http://localhost:8000 |
| `STUN_SERVERS` | —Å–ø–∏—Å–∫–æ–º, –∑–∞–ø—è—Ç—ã–µ | stun:stun.l.google.com:19302 |
| `TURN_URLS` / `TURN_URL` | —Å–ø–∏—Å–æ–∫ –∏–ª–∏ –æ–¥–∏–Ω–æ—á–Ω—ã–π TURN | turn:your.turn:3478 |
| `TURN_USERNAME` / `TURN_PASSWORD` | –∫—Ä–µ–¥—ã TURN | webcall / secret |

–ï—Å–ª–∏ –∑–∞–¥–∞–Ω—ã `TURN_URLS`, –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è; –∏–Ω–∞—á–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `TURN_URL` –æ–Ω –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker Compose)
```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env (REGISTRATION_SECRET, DATABASE_URL –∏ —Ç.–¥.)
docker compose up --build -d
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã –∞–≤—Ç–æ):
docker compose exec api alembic upgrade head
```
–û—Ç–∫—Ä–æ–π—Ç–µ:
- Swagger (–µ—Å–ª–∏ –Ω–µ —Å–∫—Ä—ã—Ç): http://localhost:8000/docs
- –ö–ª–∏–µ–Ω—Ç: http://localhost:8000/static/index.html
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: http://localhost:8000/static/auth.html

## üß™ –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (Poetry)
```bash
poetry install
poetry run alembic upgrade head
poetry run uvicorn app.bootstrap.asgi:app --reload
```
URL—ã —Ç–µ –∂–µ (–ø–æ—Ä—Ç 8000).

## üóÑ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
SQLAlchemy + Alembic.
- –†–µ–≤–∏–∑–∏–∏: `alembic/versions/*.py`
- –°–æ–∑–¥–∞—Ç—å: `alembic revision -m "message" --autogenerate`
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å: `alembic upgrade head`

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: `POST /api/v1/auth/register` (—Ç–µ–ª–æ: email, username, password, secret)
- –õ–æ–≥–∏–Ω: `POST /api/v1/auth/login` ‚Üí JWT (`access_token`)
- –°–µ–∫—Ä–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω; –Ω–µ–≤–µ—Ä–Ω—ã–π ‚Äî 403. –°–º–µ–Ω–∏—Ç—å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `REGISTRATION_SECRET`.

## üì° WebSocket —Å–∏–≥–Ω–∞–ª–∏–Ω–≥
–ü—É—Ç—å: `ws://<host>/ws/rooms/{room}?token=JWT`
–°–æ–æ–±—â–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ JSON (chat, signal, presence). –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã –≤ `static/js/`.

## üéß WebRTC ICE
REST —ç–Ω–¥–ø–æ–∏–Ω—Ç: `GET /api/v1/webrtc/ice-servers` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{"iceServers": [...]}`. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ STUN/TURN –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

## üó£ –ß–∞—Ç –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∏
- –°–æ–æ–±—â–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (—Å–≤–æ–∏ —Å–ø—Ä–∞–≤–∞)
- –ò–º–µ–Ω–∞ –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö username
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å—é: —Å–ª–∞–π–¥–µ—Ä –Ω–∞ –∫–∞–∂–¥–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–µ, –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–æ–ª—É—á–∞–µ–º–æ–º—É –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫—É.

## üß© –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è `pytest` + `pytest-asyncio` + `httpx`.
```bash
poetry run pytest -q
```
–ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ–∫—Ä–µ—Ç–∞: `app/tests/test_registration_secret.py`.

## üß± –õ–æ–≥–∏ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
–°–µ–π—á–∞—Å structlog –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ú–µ—Ç—Ä–∏–∫–∏/Prometheus ‚Äî TODO.

## ü™™ –û—à–∏–±–∫–∏
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ `presentation.errors` (–∏ –ª–æ–∫–∞–ª—å–Ω–æ –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö). –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ HTTP –∫–æ–¥—ã: 401/403/409/422.

## üß† –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ
–ò–¥–µ–∏:
- Rate limiting / throttling
- –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
- –ó–∞–ø–∏—Å—å –∑–≤–æ–Ω–∫–æ–≤ (SFU –ª–∏–±–æ –º–µ–¥–∏–∞—Å–µ—Ä–≤–µ—Ä)
- –§–∞–π–ª–æ–≤—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è –≤ —á–∞—Ç
- UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è TURN
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–±–∞–Ω/–º—É—Ç)

## üèó –ü—Ä–∏–Ω—Ü–∏–ø—ã –∫–æ–¥–∞
- Use-case —Å–ª–æ–π –Ω–µ –∑–Ω–∞–µ—Ç –æ FastAPI/SQLAlchemy
- DI —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `presentation.api.deps`
- Pydantic v2 DTO –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ
- –ö–æ–Ω—Å—Ç–∞–Ω—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ (hmac.compare_digest)

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
–ò–∑–º–µ–Ω–∏—Ç–µ `REGISTRATION_SECRET` –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å. –ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–æ–¥ ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥.

## üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- JWT —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- –°–µ–∫—Ä–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–∫—Ä—ã—Ç –≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (override env)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å CSP/SECURE –≤ –ø—Ä–æ–¥–µ)

## üåê –ü—Ä–æ–¥–∞–∫—à–Ω –Ω–∞–±—Ä–æ—Å–æ–∫
1. Reverse proxy (Nginx / Caddy) ‚Üí API:8000
2. HTTPS –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π (Let‚Äôs Encrypt)
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TURN (public IP, firewall UDP –¥–∏–∞–ø–∞–∑–æ–Ω)
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ CORS —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏
5. –õ–æ–≥–∏ –≤ stdout + —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–±–æ—Ä (Loki/ELK)
6. Backups Postgres (pg_dump + cron)

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è
MIT.

---
–í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã (JWT, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π, TURN, –ë–î) –∑–∞–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ .env. –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
